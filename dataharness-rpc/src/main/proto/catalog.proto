syntax = "proto3";

package org.dataharness.proto;

option java_multiple_files = true;
option java_package = "org.dataharness.proto";
option java_outer_classname = "CatalogProto";

enum SchemaType {
  SCHEMA_TYPE_UNSPECIFIED = 0;
  AVRO = 1;
  PROTOBUF = 2;
}

service CatalogService {
  rpc CreateTable(CreateTableRequest) returns (CreateTableResponse) {}
  rpc UpsertSources(UpsertSourcesRequest) returns (UpsertSourcesResponse) {}
  rpc LoadTable(LoadTableRequest) returns (LoadTableResponse) {}
  rpc ListTables(ListTablesRequest) returns (ListTablesResponse) {}
  rpc SetSchema(SetSchemaRequest) returns (SetSchemaResponse) {}
  rpc DropTable(DropTableRequest) returns (DropTableResponse) {}
  rpc TableExists(TableExistsRequest) returns (TableExistsResponse) {}
}

message CreateTableRequest {
  string name = 1;
}

message CreateTableResponse {
  bool success = 1;
  string message = 2;
  int64 table_id = 3;
}

message UpsertSourcesRequest {
  repeated SourceUpdate sources = 1;
}

message SourceUpdate {
  string table_name = 1;
  oneof source {
    KafkaSourceMessage kafka_source = 2;
    IcebergSourceMessage iceberg_source = 3;
    YugabyteDBSourceMessage yugabytedb_source = 4;
    PostgresDBSourceMessage postgresdb_source = 5;
  }
}

message UpsertSourcesResponse {
  bool success = 1;
  string message = 2;
}

message LoadTableRequest {
  string table_name = 1;
}

message LoadTableResponse {
  optional string avro_schema = 1;
  optional string iceberg_schema = 2;
  optional string protobuf_schema = 3;
  repeated TableSourceMessage sources = 4;
}

message KafkaSourceMessage {
  string name = 1;
  string trino_catalog_name = 2;
  string trino_schema_name = 3;
  int64 start_offset = 4;
  int64 end_offset = 5;
  int32 partition_number = 6;
  string topic_name = 7;
  string broker_urls = 8;
  SchemaType schema_type = 9;
  string schema = 10;
}

message IcebergSourceMessage {
  string name = 1;
  string trino_catalog_name = 2;
  string trino_schema_name = 3;
  string table_name = 4;
  int64 read_timestamp = 5;
  string spark_catalog_name = 6;
  string spark_schema_name = 7;
}

message YugabyteDBSourceMessage {
  string name = 1;
  string trino_catalog_name = 2;
  string trino_schema_name = 3;
  string table_name = 4;
  string jdbc_url = 5;
  string username = 6;
  string password = 7;
  int64 read_timestamp = 8;
}

message PostgresDBSourceMessage {
  string name = 1;
  string trino_catalog_name = 2;
  string trino_schema_name = 3;
  string table_name = 4;
  string jdbc_url = 5;
  string username = 6;
  string password = 7;
  int64 read_timestamp = 8;
  string history_table_name = 9;
  string table_name_no_tstzrange = 10;
  string history_table_name_no_tstzrange = 11;
}

message TableSourceMessage {
  string table_name = 1;
  oneof source {
    KafkaSourceMessage kafka_source = 2;
    IcebergSourceMessage iceberg_source = 3;
    YugabyteDBSourceMessage yugabytedb_source = 4;
    PostgresDBSourceMessage postgresdb_source = 5;
  }
}

message SetSchemaRequest {
  string table_name = 1;
  optional string avro_schema = 2;
  optional string iceberg_schema = 3;
  optional string protobuf_schema = 4;
}

message SetSchemaResponse {
  bool success = 1;
  string message = 2;
}

message ListTablesRequest {
}

message ListTablesResponse {
  repeated string table_names = 1;
}

message DropTableRequest {
  string table_name = 1;
}

message DropTableResponse {
  bool success = 1;
  string message = 2;
}

message TableExistsRequest {
  string table_name = 1;
}

message TableExistsResponse {
  bool exists = 1;
}
